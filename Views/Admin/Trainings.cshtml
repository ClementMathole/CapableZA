@model List<Capableza.Web.Models.AssignedTraining>
@{
    ViewData["Title"] = "Assigned Trainings";
    Layout = "~/Views/Shared/_Layout.cshtml";
    var employeeMap = ViewBag.EmployeeMap as Dictionary<string, string> ?? new Dictionary<string, string>();
}

<style>
    .header-actions .btn-add-training {
        background-color: #0F6F84; border-color: #0F6F84; color: white;
        font-size: 0.8rem; padding: 0.3rem 0.8rem; border-radius: 0.375rem;
    }
    .header-actions .btn-add-training:hover { background-color: #0B5B6D; border-color: #0B5B6D; }

    .training-table-card { border: none; border-radius: 0.75rem; box-shadow: 0 .125rem .25rem rgba(0,0,0,.075); overflow: hidden; }
    .training-table thead th {
        font-weight: 600; font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.5px;
        background-color: #0F6F84; color: white;
        border: none; padding: 0.75rem 1rem; vertical-align: middle;
    }
    .training-table tbody td { vertical-align: middle; font-size: 0.9rem; border-top: 1px solid #dee2e6; padding: 0.75rem 1rem; }
    .training-table tbody tr:first-child td { border-top: none; }

    .badge { font-size: 0.75rem; padding: 0.3em 0.6em; }
    .assigned-list { font-size: 0.8rem; color: #6c757d; }
    .action-icon { color: #6c757d; text-decoration: none; padding: 0.2rem; }
    .action-icon:hover { color: #0F6F84; }
    .action-icon-delete { color: #6c757d; }
    .action-icon-delete:hover { color: #dc3545; }
    .btn-link-icon { background: none; border: none; padding: 0.2rem; margin: 0; vertical-align: middle; }
    .table > :not(caption) > * > * { padding: 0.75rem 1rem; }
</style>

<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-1 pb-2 mb-3 border-bottom">
    <h1 class="h2">@ViewData["Title"]</h1>
    <div class="d-flex align-items-center header-actions">
        <a asp-action="AddTraining" asp-controller="Admin" class="btn btn-sm btn-add-training">
             <i class="fa fa-plus me-1"></i> Assign New Training
        </a>
    </div>
</div>

@if (!Model.Any())
{
    <div class="card shadow-sm">
        <div class="card-body text-center text-muted py-5">
             <i class="fa fa-school fa-3x mb-3 text-secondary"></i>
            <p>No trainings have been assigned yet.</p>
             <a asp-action="AddTraining" asp-controller="Admin" class="btn btn-primary-teal btn-sm mt-2">
                 Assign First Training
            </a>
        </div>
    </div>
}
else
{
    <div class="card training-table-card shadow-sm">
        <div class="table-responsive">
            <table class="table training-table mb-0 align-middle">
                <thead>
                    <tr>
                        <th style="width: 20%;">Title</th>
                        <th style="width: 15%;">Provider</th>
                        <th style="width: 15%;">Dates</th>
                        <th style="width: 10%;">Level</th>
                        <th style="width: 10%;" class="text-center">Status</th>
                        <th style="width: 10%;" class="text-center">Enrolled</th>
                        <th style="width: 10%;">Assigned To</th>
                        <th style="width: 10%;" class="text-center">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in Model)
                    {
                        <tr>
                            <td class="fw-medium">@item.Title</td>
                            <td>@item.Provider</td>
                            <td class="small">@item.StartDate - @item.EndDate</td>
                            <td>@item.Level</td>
                            <td class="text-center">
                                <span class="badge @(item.Status == "Completed" ? "bg-success-subtle text-success-emphasis" : (item.Status == "On-Going" ? "bg-warning-subtle text-warning-emphasis" : "bg-info-subtle text-info-emphasis")) rounded-pill text-capitalize">
                                    @item.Status
                                </span>
                            </td>
                            <td class="text-center">@item.EnrolledCount</td>
                            <td>
                                @if(item.AssignedTo.Any())
                                {
                                    var firstFewNames = item.AssignedTo.Take(2).Select(uid => employeeMap.GetValueOrDefault(uid, uid.Substring(0, 6) + "..."));
                                    var fullList = string.Join("\n", item.AssignedTo.Select(uid => employeeMap.GetValueOrDefault(uid, uid)));
                                    <span class="assigned-list" data-bs-toggle="tooltip" data-bs-placement="top" title="@fullList">
                                        @string.Join(", ", firstFewNames)
                                        @if (item.AssignedTo.Count > 2) { <text>...</text> }
                                    </span>
                                } else {
                                     <span class="assigned-list text-muted">None</span>
                                }
                            </td>
                            <td class="text-center">
                                <form asp-action="DeleteAssignedTraining"
                                      asp-route-id="@item.Id"
                                      method="post"
                                      class="d-inline"
                                      onsubmit="return confirm('Are you sure you want to delete the assignment for training: @item.Title?');">
                                    @Html.AntiForgeryToken()

                                    <a asp-action="EditTraining"
                                       asp-route-id="@item.Id"
                                       class="btn btn-sm me-2"
                                       title="Edit">
                                        <i class="fa fa-edit" style="color: dimgrey;"></i>
                                    </a>

                                    <button type="submit"
                                            class="btn btn-link-icon p-0 action-icon action-icon-delete"
                                            title="Delete Assignment">
                                        <i class="fa fa-trash fa-fw"></i>
                                    </button>
                                </form>
                            </td>

                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
}


@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
          return new bootstrap.Tooltip(tooltipTriggerEl)
        })
    </script>
}